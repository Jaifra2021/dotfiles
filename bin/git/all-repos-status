#!/usr/bin/env bash
#
# Display info about repositories that have changes or commits not on the latest tag

echo "Showing repos that have changes or commits not on the latest tag"
for repo in $(all-repos-list | tr '\n' '\0' | xargs -0); do
    _filestatus=$(filestatus $repo)
    remote=$(repo-remote $repo)
    branch=$(branchname $repo)
    newcommits=$(unpushed-commits $repo)
    stashes=$(stashlist $repo)
    next_tag_commits=$(since-lasttag $repo)
    if [[ -n "$_filestatus" || -n "$newcommits" || -n "$stashes" || -n "$next_tag_commits" ]]; then
        echo -e "\n==============="
        echo -e "$repo -- $remote --  $branch\n$_filestatus"
        [[ -n "$newcommits" ]] && echo -e "\nNot pushed\n$newcommits"
        [[ -n "$stashes" ]] && echo -e "\nStashes\n$stashes"
        [[ -n "$next_tag_commits" ]] && echo -e "\nNew commits since latest tag\n$next_tag_commits"
    fi
done | less -FX
