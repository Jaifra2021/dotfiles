#!/usr/bin/env bash

# Exit script if not supplied with, or called from a path in a git repository
path=$1
[[ -z "$path" ]] && path=$(pwd)
path=$(repo-path $path)
[[ -z "$path" ]] && exit 1

cd $path
echo -e "\n===============\n$(pwd)"
filestatus=$(git status -s)
remote=$(repo-remote)
branch=$(branchname)
if [[ -z "$remote" ]]; then
    echo " - Local-only repo, not updating"
elif [[ -z "$filestatus" ]]; then
    echo " - Repository is clean.. gonna do 'pull'"
    git pull
elif [[ "$branch" =~ (master|production) ]]; then
    stashstatus=$(git stash)
    if [[ $stashstatus == "No local changes to save" ]]; then
        echo " - Repository is clean (w/ untracked files).. gonna do 'pull'"
        git pull
    else
        echo " - Dirty repo on master or production.. gonna do 'stash pull pop'"
        echo "$stashstatus"
        git pull
        git stash pop
    fi
else
    echo " - Dirty random branch, not updating"
fi
