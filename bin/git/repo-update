#!/usr/bin/env bash

# Exit script if not supplied with, or called from a path in a git repository
path=$1
[[ -z "$path" ]] && path=$(pwd)
path=$(repo-path $path)
[[ -z "$path" ]] && exit 1

cd $path
remote=$(repo-remote)
branch=$(branchname)
tracking=$(branchname-tracking)
echo -e "\n===============\n$(pwd) -- $branch"
if [[ -z "$remote" ]]; then
    echo " - Local-only repo, not updating"
elif [[ -n "$tracking" ]]; then
    stashstatus=$(git stash)
    if [[ $stashstatus == "No local changes to save" ]]; then
        echo " - Repository is clean.. gonna do 'pull'"
        git pull
    else
        echo " - Dirty repo with tracking branch.. gonna do 'stash pull pop'"
        echo "$stashstatus"
        git pull
        git stash pop
    fi
else
    echo " - No tracking branch, gonna do 'remote update'"
    git remote update
fi
