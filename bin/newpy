#!/usr/bin/env bash

name=$1
[[ -z "$name" ]] && exit 1
shift

req_file="requirements.txt"

while [[ ! -z "$1" ]]; do
    case "$1" in
        --tasty)
            req_file="requirements-tastypie.txt"
            ;;
        *)
            echo "Unknown parameter: $1" >&2
            exit 1
    esac

    if ! shift; then
        echo "Missing parameter argument" >&2
        exit 1
    fi
done

component_dir_path="$HOME/py/components/$name"

if [[ -d $component_dir_path ]]; then
    echo "$component_dir_path already exists" >&2
    exit 1
fi

mkdir -pv $component_dir_path
cp -av $HOME/py/.skel/setup.bash $component_dir_path
cp -av $HOME/py/.skel/$req_file $component_dir_path/requirements.txt
echo -e "${name}\n----------\n" > $component_dir_path/$name.md || exit 1

cd $component_dir_path
if [[ -z "$TMUX" ]]; then
    # Open the markdown file with vim
    vim + -c 'startinsert' $name.md
else
    # Actually create the environment so we can start ipython in a tmux pane
    ./setup.bash

    # Create a new window in existing tmux session
    tmux new-window -n "py-$name"

    # Split the tmux window and open the file with vim (in insert mode, at the
    # end of the file)
    tmux split-window -h "source env/bin/activate && ipython"
    tmux split-window -v "vim + -c 'startinsert' $name.md"
fi
